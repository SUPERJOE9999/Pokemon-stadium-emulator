<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Pok√©mon Stadium - Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Mona+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}html{height:100%}
        :root{--fg:#e6edf3;--fm:#8b949e;--fs:#6e7681;--ok:#50c878;--warn:#d29922;--bg:#1a1708;--card:#2d2810;--inset:#0d0c04;--bdr:#a08020;--bdm:#605010;--acc:#ffd93d;--acce:#f0c000;--btng:linear-gradient(145deg,#f0c000,#d4a800);--btns:#8a7000;--glow:rgba(240,192,0,0.15)}
        body{background:var(--bg);background-image:radial-gradient(ellipse at top,var(--glow) 0%,transparent 50%);min-height:100%;display:flex;justify-content:center;align-items:center;font-family:'Mona Sans',sans-serif;padding:10px;touch-action:manipulation;-webkit-user-select:none;user-select:none;overflow-x:hidden}
        [class*="virtualGamepad"],[id*="virtualGamepad"],[class*="ejs_virtualGamepad"],[class*="game-touch"],[class*="ejs__controls"]{display:none!important;width:0!important;height:0!important;opacity:0!important;pointer-events:none!important;position:absolute!important;left:-9999px!important}
        .ct{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%;max-width:500px}
        .hdr{display:flex;align-items:center;gap:10px;padding:8px 16px;background:var(--card);border:1px solid var(--bdr);border-radius:6px;width:100%;max-width:380px}
        .hdr-i{font-size:24px}.hdr-t{display:flex;flex-direction:column}.hdr-m{color:var(--fg);font-size:16px;font-weight:700}.hdr-s{color:var(--fm);font-size:11px;font-family:'JetBrains Mono',monospace}
        .badge{margin-left:auto;font-size:10px;font-weight:600;padding:2px 8px;border-radius:12px}.badge.p1{background:#f0c000;color:#000}.badge.p2{background:#6040c0;color:#fff}
        .ps{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--card);border:1px solid var(--bdr);border-radius:6px;max-width:380px;width:100%;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--fm)}
        .pd{width:8px;height:8px;border-radius:50%;background:var(--fs);flex-shrink:0}.pd.on{background:var(--ok);animation:pu 2s ease-in-out infinite}.pd.wait{background:var(--warn);animation:pu 1s ease-in-out infinite}
        @keyframes pu{0%,100%{opacity:1}50%{opacity:.4}}
        .cb{width:min(380px,95vw);background:var(--card);border-radius:8px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,.4);border:2px solid var(--bdr)}
        .cl{color:var(--fm);font-size:10px;font-family:'JetBrains Mono',monospace;font-weight:bold;letter-spacing:2px;text-align:center;margin-bottom:8px}
        .sa{width:100%;background:var(--inset);border-radius:6px;padding:10px;box-shadow:inset 0 4px 15px rgba(0,0,0,.8)}
        .or{display:flex;justify-content:space-between;width:100%;padding:0 5px;margin-bottom:5px}
        .ob{background:var(--card);border:1px solid var(--bdm);border-radius:4px;color:var(--fm);font-size:9px;font-family:'JetBrains Mono',monospace;padding:3px 10px;cursor:pointer}
        #game{width:100%;aspect-ratio:4/3;background:#000;border-radius:4px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative}#game *{touch-action:none}
        .gp{text-align:center;color:var(--fs);padding:20px}.gp svg{width:48px;height:48px;fill:var(--fs);margin-bottom:10px;opacity:.5}.gp p{font-size:11px;font-family:'JetBrains Mono',monospace}
        #mirror-video{width:100%;height:100%;object-fit:contain;display:none;background:#000}
        .ctrl{width:min(380px,95vw);background:var(--card);border-radius:12px;padding:15px;box-shadow:0 8px 20px rgba(0,0,0,.3);border:2px solid var(--bdr);display:flex;flex-direction:column;gap:12px}
        .cr{display:flex;justify-content:space-between;align-items:center;padding:0 10px}
        .sb{display:flex;justify-content:space-between;padding:0 10px;gap:8px}
        .sbt{flex:1;height:28px;background:var(--btng);border:2px solid var(--btns);border-radius:6px;color:var(--fg);font-size:11px;font-weight:bold;font-family:'JetBrains Mono',monospace}.sbt:active,.sbt.pressed{transform:translateY(2px);opacity:.8}
        .dp{width:100px;height:100px;position:relative}
        .db{position:absolute;background:linear-gradient(145deg,var(--card),var(--inset));border:2px solid var(--bdm);display:flex;align-items:center;justify-content:center;color:var(--fm);font-size:16px}.db:active,.db.pressed{background:var(--btng);color:var(--fg)}
        .du,.dd{width:34px;height:36px;left:33px}.du{top:0;border-radius:6px 6px 0 0}.dd{bottom:0;border-radius:0 0 6px 6px}
        .dl,.dr{width:36px;height:34px;top:33px}.dl{left:0;border-radius:6px 0 0 6px}.dr{right:0;border-radius:0 6px 6px 0}
        .dc{position:absolute;width:34px;height:34px;top:33px;left:33px;background:var(--inset);border:2px solid var(--bdm)}
        .cbs{display:flex;flex-direction:column;align-items:center;gap:2px}.crow{display:flex;gap:20px}.abn{display:flex;gap:10px}
        .ab{width:42px;height:42px;border-radius:50%;background:var(--btng);border:2px solid var(--btns);font-weight:bold;font-size:12px;font-family:'JetBrains Mono',monospace;color:var(--fg);box-shadow:0 3px 0 var(--btns)}.ab:active,.ab.pressed{transform:translateY(2px);box-shadow:0 1px 0 var(--btns)}
        .cbtn{width:32px;height:32px;border-radius:50%;background:#f0c000;border:2px solid #a08000;font-size:9px;font-weight:bold;color:#000}.cbtn:active,.cbtn.pressed{transform:translateY(2px)}
        .mb{display:flex;justify-content:center;gap:15px}
        .mbt{width:60px;height:18px;background:var(--inset);border:1px solid var(--bdm);border-radius:10px;color:var(--fm);font-size:8px;font-family:'JetBrains Mono',monospace}.mbt:active,.mbt.pressed{background:var(--btng);color:var(--fg)}
        .az{display:flex;justify-content:center;align-items:center;flex-direction:column;gap:2px}
        .ac{width:110px;height:110px;position:relative;flex-shrink:0}
        .abas{width:110px;height:110px;border-radius:50%;background:radial-gradient(circle at 40% 35%,var(--card),var(--inset));border:2px solid var(--bdm);position:relative;box-shadow:inset 0 2px 8px rgba(0,0,0,.5)}
        .astk{width:50px;height:50px;border-radius:50%;background:radial-gradient(circle at 40% 35%,#555,#333);border:2px solid #666;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);touch-action:none}.astk.active{border-color:var(--acc)}
        .al{text-align:center;color:var(--fs);font-size:8px;font-family:'JetBrains Mono',monospace;letter-spacing:1px;margin-top:2px}
        .ba{background:linear-gradient(145deg,#2070d0,#1858a8)!important;border-color:#103870!important;box-shadow:0 3px 0 #103870!important}.ba:active,.ba.pressed{box-shadow:0 1px 0 #103870!important}
        .pt{display:flex;align-items:center;justify-content:center;gap:6px;padding:4px 14px;border-radius:20px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;letter-spacing:2px;margin:0 auto 4px}
        .pt.p1{background:#f0c000;color:#000}.pt.p2{background:#6040c0;color:#fff}.pt .dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:pu 2s ease-in-out infinite}
        .c2 .sbt{background:linear-gradient(145deg,#6040c0,#4830a0);border-color:#302060}
        .c2 .db:active,.c2 .db.pressed{background:linear-gradient(145deg,#6040c0,#4830a0)}
        .c2 .ab{background:linear-gradient(145deg,#6040c0,#4830a0);border-color:#302060;box-shadow:0 3px 0 #302060}
        .c2 .ba{background:linear-gradient(145deg,#d04040,#b03030)!important;border-color:#702020!important;box-shadow:0 3px 0 #702020!important}
        .c2 .cbtn{background:#e060e0;border-color:#a040a0;color:#000}
        .c2 .mbt:active,.c2 .mbt.pressed{background:linear-gradient(145deg,#6040c0,#4830a0)}
        .c2 .astk.active{border-color:#8060e0}
        .tov{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:50;cursor:pointer;border-radius:4px}
        .tov.hidden{display:none}.tov svg{width:48px;height:48px;fill:var(--acc);margin-bottom:12px;animation:tb 2s ease-in-out infinite}
        @keyframes tb{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
        .tt{color:var(--acc);font-size:18px;font-weight:800;letter-spacing:3px;text-transform:uppercase}.ts{color:var(--fm);font-size:10px;font-family:'JetBrains Mono',monospace;margin-top:6px}
        .st{color:var(--fm);font-size:11px;text-align:center;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;justify-content:center;gap:6px}
        .sd{width:8px;height:8px;border-radius:50%;background:var(--fs)}.sd.ok{background:var(--ok);animation:pu 2s ease-in-out infinite}.sd.wn{background:var(--warn);animation:pu 1s ease-in-out infinite}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;justify-content:center;align-items:center;padding:10px}.modal.show{display:flex}
        .mc{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:16px;width:min(360px,95vw)}.mh{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--bdr)}.mti{color:var(--fg);font-size:16px;font-weight:700}
        .ms{color:var(--fm);font-size:11px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:1px;margin:14px 0 8px;display:flex;align-items:center;gap:8px}.ms::after{content:'';flex:1;height:1px;background:var(--bdm)}
        .mo{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:var(--bg);border:1px solid var(--bdm);border-radius:6px;margin-bottom:8px}.mo label{color:var(--fg);font-size:13px;font-weight:500}.mo button{background:var(--acce);border:none;border-radius:6px;padding:6px 12px;font-size:12px;font-weight:600;color:var(--fg);cursor:pointer}
        .mcl{display:block;width:100%;margin-top:12px;padding:10px;background:var(--bg);border:1px solid var(--bdr);border-radius:6px;color:var(--fg);font-size:14px;font-weight:600;cursor:pointer}
    </style>
</head>
<body>
<div class="ct">
    <div class="hdr"><div class="hdr-i">‚ö°</div><div class="hdr-t"><span class="hdr-m">Pok√©mon Stadium</span><span class="hdr-s" id="room-info">Online</span></div><span class="badge" id="pbadge">P?</span></div>
    <div class="ps"><div class="pd wait" id="pdot"></div><span id="ptxt">Connecting...</span></div>
    <div class="cb"><div class="cl">POK√âMON STADIUM</div><div class="sa"><div class="or"><button class="ob" id="options-btn">‚öô Settings</button></div>
        <div id="game"><div class="gp"><svg viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM1.5 8a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0Zm4.879-2.773 4.264 2.559a.25.25 0 0 1 0 .428l-4.264 2.559A.25.25 0 0 1 6 10.559V5.442a.25.25 0 0 1 .379-.215Z"/></svg><p>Loading Pok√©mon Stadium...</p></div>
        <video id="mirror-video" autoplay playsinline muted></video>
        <div class="tov" id="tov"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg><div class="tt">Touch to Start</div><div class="ts">Pok√©mon Stadium</div></div>
    </div></div></div>
    <div id="czone"></div>
    <div class="st"><span class="sd" id="sdot"></span><span id="stxt">Loading...</span></div>
</div>
<div class="modal" id="smod"><div class="mc"><div class="mh"><span class="mti">‚öô Settings</span></div>
    <div class="ms">Game</div>
    <div class="mo"><label>Sound</label><button id="mute-btn">üîä ON</button></div>
    <div class="mo"><label>Screenshot</label><button id="ss-btn">üì∑ SNAP</button></div>
    <div class="mo"><label>Restart</label><button id="rst-btn">üîÑ RESTART</button></div>
    <div class="mo"><label>Lobby</label><button onclick="location.href='https://superjoe9999.github.io/Pokemon-stadium-lobby/'">üè† LOBBY</button></div>
    <button class="mcl" id="sclose">Close</button>
</div></div>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
const FOLDER_ID='1LruVVxvwOmB89y-7UPT-0DWhAV_QgCYR',API_KEY='AIzaSyAL1l3O7Jr8M635xZsxT3jI9yE-yp13KTc';
const CORS_PROXIES=['https://api.allorigins.win/raw?url=','https://corsproxy.io/?'];
const P=new URLSearchParams(location.search),myP=parseInt(P.get('player'))||1,room=P.get('room')||'',myIdx=myP-1,isHost=myP===1;
let emu=null,mut=false,peer=null,conn=null,pConn=false;
document.getElementById('pbadge').textContent='P'+myP;
document.getElementById('pbadge').className='badge '+(isHost?'p1':'p2');
document.getElementById('room-info').textContent=room?'Room: '+room:'Local';

// Build controller
const p2=myP===2,px=p2?'p2-':'',cz=document.getElementById('czone');
cz.innerHTML=`<div class="pt ${p2?'p2':'p1'}"><span class="dot"></span> ${p2?'üéÆ PLAYER 2':'‚ö° PLAYER 1'}</div>
<div class="ctrl ${p2?'c2':''}"><div class="sb"><button class="sbt" id="${px}btn-l">L</button><button class="sbt" id="${px}btn-z">Z</button><button class="sbt" id="${px}btn-r">R</button></div>
<div class="cr"><div class="dp"><button class="db du" id="${px}btn-up">‚ñ≤</button><button class="db dd" id="${px}btn-down">‚ñº</button><button class="db dl" id="${px}btn-left">‚óÄ</button><button class="db dr" id="${px}btn-right">‚ñ∂</button><div class="dc"></div></div>
<div class="cbs"><button class="cbtn" id="${px}btn-cup">C‚ñ≤</button><div class="crow"><button class="cbtn" id="${px}btn-cleft">C‚óÄ</button><button class="cbtn" id="${px}btn-cright">C‚ñ∂</button></div><button class="cbtn" id="${px}btn-cdown">C‚ñº</button></div>
<div class="abn"><button class="ab ba" id="${px}btn-a">A</button><button class="ab" id="${px}btn-b">B</button></div></div>
<div class="mb"><button class="mbt" id="${px}btn-start">START</button></div>
<div class="az"><div class="ac"><div class="abas" id="${px}analog-base"><div class="astk" id="${px}analog-stick"></div></div></div><div class="al">ANALOG STICK</div></div></div>`;

// Kill virtual gamepad
function kv(){document.querySelectorAll('[class*="virtualGamepad"],[id*="virtualGamepad"],[class*="ejs_virtualGamepad"],[class*="game-touch"],[class*="ejs__controls"]').forEach(e=>e.remove())}
new MutationObserver(ms=>{for(const m of ms)for(const n of m.addedNodes)if(n.nodeType===1){const c=((n.className||'')+'').toLowerCase();if(c.includes('virtualgamepad')||c.includes('game-touch')||c.includes('ejs__controls'))n.remove()}}).observe(document.body,{childList:true,subtree:true});
setInterval(kv,300);

// Peer connection
function setupPeer(){
    if(!room){document.getElementById('ptxt').textContent='Local mode';document.getElementById('pdot').className='pd';return}
    const myId=isHost?'pkstadium-emu-'+room:'pkstadium-emu-p2-'+room;
    const rId=isHost?'pkstadium-emu-p2-'+room:'pkstadium-emu-'+room;
    peer=new Peer(myId,{debug:0,config:{iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}]}});
    peer.on('open',()=>{if(!isHost)tryConn(rId,0);else document.getElementById('ptxt').textContent='Waiting for P2...'});
    peer.on('connection',c=>{conn=c;onOpen()});
    if(isHost)peer.on('call',call=>{const t=()=>{const cv=document.querySelector('#game canvas');if(cv)try{call.answer(cv.captureStream(30))}catch(e){}else setTimeout(t,1000)};t()});
    peer.on('error',e=>{if(e.type==='peer-unavailable')setTimeout(()=>tryConn(rId,0),2000)});
}
function tryConn(r,a){if(pConn||a>20)return;document.getElementById('ptxt').textContent='Connecting ('+(a+1)+')...';conn=peer.connect(r,{reliable:true});conn.on('open',onOpen);conn.on('error',()=>setTimeout(()=>tryConn(r,a+1),2000))}
function onOpen(){
    pConn=true;document.getElementById('pdot').className='pd on';document.getElementById('ptxt').textContent='P'+(isHost?'2':'1')+' connected!';
    conn.on('data',d=>{if(d.t==='i'&&emu?.gameManager)emu.gameManager.simulateInput(d.p,d.c,d.v)});
    conn.on('close',()=>{pConn=false;document.getElementById('pdot').className='pd';document.getElementById('ptxt').textContent='Disconnected'});
    if(!isHost)reqMirror();
    if(isHost&&emu?.gameManager)setTimeout(sendStream,2000);
}
function sendStream(){if(!peer||!pConn)return;const cv=document.querySelector('#game canvas');if(!cv)return;try{peer.call('pkstadium-emu-p2-'+room,cv.captureStream(30))}catch(e){}}
function reqMirror(){if(!peer)return;try{const dc=document.createElement('canvas');dc.width=2;dc.height=2;const call=peer.call('pkstadium-emu-'+room,dc.captureStream(1));call.on('stream',s=>{const v=document.getElementById('mirror-video');v.srcObject=s;v.style.display='block';const ph=document.querySelector('.gp');if(ph)ph.style.display='none';document.getElementById('stxt').textContent='Watching P1 screen'})}catch(e){}}
function snd(c,v){if(conn&&pConn)try{conn.send({t:'i',p:myIdx,c:c,v:v})}catch(e){}}

// Drive
async function fetchDrive(){
    const fs=[];let pt='';
    do{let u=`https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents&key=${API_KEY}&pageSize=1000&fields=nextPageToken,files(id,name,size)`;if(pt)u+='&pageToken='+pt;const r=await fetch(u);if(!r.ok)throw new Error('API fail');const d=await r.json();(d.files||[]).filter(f=>/\.(n64|z64|v64)$/i.test(f.name)).forEach(f=>fs.push({id:f.id,name:f.name.replace(/\.(n64|z64|v64)$/i,'')}));pt=d.nextPageToken}while(pt);return fs;
}
async function loadRom(id,name){
    document.getElementById('sdot').className='sd wn';document.getElementById('stxt').textContent='Loading '+name+'...';
    try{let b=null;try{const r=await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media&key=${API_KEY}`);if(r.ok)b=await r.blob()}catch(e){}
    if(!b||b.size<1000){const pu=`https://drive.google.com/uc?export=download&id=${id}`;for(const px of CORS_PROXIES){try{const r=await fetch(px+encodeURIComponent(pu));if(r.ok){const d=await r.blob();if(d.size>1000&&!d.type.includes('text/html')){b=d;break}const t=await d.text();if(t.includes('confirm=')){const m=t.match(/confirm=([^&"']+)/);if(m){const cr=await fetch(px+encodeURIComponent(`https://drive.google.com/uc?export=download&confirm=${m[1]}&id=${id}`));if(cr.ok){b=await cr.blob();if(b.size>1000)break}}}}}catch(e){}}}
    if(!b||b.size<1000)throw new Error('fail');initEmu(URL.createObjectURL(b),name)}catch(e){document.getElementById('sdot').className='sd';document.getElementById('stxt').textContent='Load failed'}
}
function initEmu(url,name){
    const g=document.getElementById('game');const ph=g.querySelector('.gp');if(ph)ph.remove();
    window.EJS_player='#game';window.EJS_core='n64';window.EJS_gameName=name;window.EJS_color='#101010';window.EJS_startOnLoaded=true;
    window.EJS_pathtodata='https://cdn.emulatorjs.org/stable/data/';window.EJS_gameUrl=url;
    window.EJS_VirtualGamepadSettings=false;window.EJS_defaultOptions={'virtual-gamepad':false};window.EJS_noVirtualGamepad=true;
    window.EJS_Buttons={playPause:false,restart:false,mute:false,settings:false,fullscreen:false,saveState:false,loadState:false,screenRecord:false,gamepad:false,cheat:false,volume:false,quickSave:false,quickLoad:false,screenshot:false,cacheManager:false};
    const old=document.querySelector('script[src*="emulatorjs"]');if(old)old.remove();window.EJS_emulator=null;emu=null;
    const s=document.createElement('script');s.src='https://cdn.emulatorjs.org/stable/data/loader.js';document.body.appendChild(s);
    document.getElementById('stxt').textContent='Loading emulator...';
}

// Controls
let csDone=false,started=false;
function setupCtrl(){
    const ne=window.EJS_emulator;if(!ne?.gameManager)return;emu=ne;
    const ov=document.getElementById('tov');if(!started){ov.classList.remove('hidden');ov.style.display='flex'}
    if(csDone)return;
    const stk=new Set([16,17,18,19,20,21,22,23]);
    const bns={'btn-b':0,'btn-a':8,'btn-start':3,'btn-up':4,'btn-down':5,'btn-left':6,'btn-right':7,'btn-l':10,'btn-r':11,'btn-z':12,'btn-cup':23,'btn-cdown':22,'btn-cleft':21,'btn-cright':20};
    const bm={};Object.entries(bns).forEach(([n,c])=>{bm[px+n]=c});
    function doI(c,v){
        if(isHost&&emu){
            let ok=false;
            try{if(emu.gameManager?.simulateInput){emu.gameManager.simulateInput(myIdx,c,v);ok=true}}catch(e){}
            if(!ok)try{if(emu.simulateInput){emu.simulateInput(myIdx,c,v);ok=true}}catch(e){}
            if(!ok)try{if(window.simulate_input){window.simulate_input(myIdx,c,v);ok=true}}catch(e){}
            if(!ok)console.warn('No input method found for',myIdx,c,v);
        }
        if(!isHost)snd(c,v);
    }
    Object.entries(bm).forEach(([id,code])=>{
        const b=document.getElementById(id);if(!b)return;const v=stk.has(code)?32767:1;
        const pr=()=>{b.classList.add('pressed');doI(code,v)};
        const rl=()=>{b.classList.remove('pressed');doI(code,0)};
        b.addEventListener('touchstart',e=>{e.preventDefault();pr()},{passive:false});
        b.addEventListener('touchend',e=>{e.preventDefault();rl()},{passive:false});
        b.addEventListener('touchcancel',e=>{e.preventDefault();rl()},{passive:false});
        b.addEventListener('mousedown',e=>{e.preventDefault();pr()});b.addEventListener('mouseup',e=>{e.preventDefault();rl()});b.addEventListener('mouseleave',rl);
    });
    // Keyboard
    const km={"ArrowUp":19,"ArrowDown":18,"ArrowLeft":17,"ArrowRight":16,"w":19,"W":19,"s":18,"S":18,"a":17,"A":17,"d":16,"D":16,"z":0,"Z":0,"x":8,"X":8,"Enter":3,"q":10,"Q":10,"e":11,"E":11,"Shift":12,"i":23,"I":23,"k":22,"K":22,"j":21,"J":21,"l":20,"L":20};
    const kd=new Set();
    document.addEventListener('keydown',e=>{if(km[e.key]!==undefined&&!kd.has(e.key)){e.preventDefault();kd.add(e.key);doI(km[e.key],stk.has(km[e.key])?32767:1)}});
    document.addEventListener('keyup',e=>{if(km[e.key]!==undefined){e.preventDefault();kd.delete(e.key);doI(km[e.key],0)}});
    // Analog
    const aSticks=[];
    (function(){
        const base=document.getElementById(px+'analog-base'),stick=document.getElementById(px+'analog-stick');
        if(!base||!stick)return;const md=28;let tid=null,cx=0,cy=0,as={u:false,d:false,l:false,r:false};
        function gc(){const r=base.getBoundingClientRect();cx=r.left+r.width/2;cy=r.top+r.height/2}
        function ua(x,y){let dx=x-cx,dy=y-cy;const di=Math.sqrt(dx*dx+dy*dy);if(di>md){dx=(dx/di)*md;dy=(dy/di)*md}
            stick.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
            const nx=dx/md,ny=dy/md,t=.25,wR=nx>t,wL=nx<-t,wD=ny>t,wU=ny<-t;
            if(wU!==as.u){doI(19,wU?32767:0);as.u=wU}if(wD!==as.d){doI(18,wD?32767:0);as.d=wD}
            if(wL!==as.l){doI(17,wL?32767:0);as.l=wL}if(wR!==as.r){doI(16,wR?32767:0);as.r=wR}}
        function ra(){stick.style.transform='translate(-50%,-50%)';stick.classList.remove('active');tid=null;
            if(as.u){doI(19,0);as.u=false}if(as.d){doI(18,0);as.d=false}if(as.l){doI(17,0);as.l=false}if(as.r){doI(16,0);as.r=false}}
        aSticks.push({tid:()=>tid,ua,ra});
        base.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();if(tid!==null)return;const t=e.changedTouches[0];tid=t.identifier;stick.classList.add('active');gc();ua(t.clientX,t.clientY)},{passive:false});
        let mdn=false;
        base.addEventListener('mousedown',e=>{e.preventDefault();mdn=true;stick.classList.add('active');gc();ua(e.clientX,e.clientY)});
        document.addEventListener('mousemove',e=>{if(mdn)ua(e.clientX,e.clientY)});
        document.addEventListener('mouseup',()=>{if(mdn){mdn=false;ra()}});
        document.addEventListener('touchmove',e=>{for(const t of e.changedTouches)for(const s of aSticks)if(s.tid()===t.identifier){e.preventDefault();s.ua(t.clientX,t.clientY)}},{passive:false});
        document.addEventListener('touchend',e=>{for(const t of e.changedTouches)for(const s of aSticks)if(s.tid()===t.identifier)s.ra()});
        document.addEventListener('touchcancel',e=>{for(const t of e.changedTouches)for(const s of aSticks)if(s.tid()===t.identifier)s.ra()});
    })();
    csDone=true;
}
// Touch overlay
document.getElementById('tov').addEventListener('click',()=>{started=true;document.getElementById('tov').style.display='none';new(window.AudioContext||window.webkitAudioContext)().resume()});
document.getElementById('tov').addEventListener('touchstart',e=>{e.preventDefault();started=true;document.getElementById('tov').style.display='none';new(window.AudioContext||window.webkitAudioContext)().resume()},{passive:false});
// Settings
const sm=document.getElementById('smod');
document.getElementById('options-btn').addEventListener('click',()=>sm.classList.add('show'));
document.getElementById('sclose').addEventListener('click',()=>sm.classList.remove('show'));
sm.addEventListener('click',e=>{if(e.target===sm)sm.classList.remove('show')});
document.getElementById('mute-btn').addEventListener('click',e=>{if(emu?.gameManager?.setVolume){mut=!mut;try{emu.gameManager.setVolume(mut?0:1)}catch(x){}e.target.textContent=mut?'üîá OFF':'üîä ON'}});
document.getElementById('ss-btn').addEventListener('click',()=>{const c=document.querySelector('#game canvas');if(c){const l=document.createElement('a');l.download='pokemon-stadium.png';l.href=c.toDataURL();l.click()}});
document.getElementById('rst-btn').addEventListener('click',()=>{if(emu?.gameManager?.restart&&confirm('Restart?'))emu.gameManager.restart();sm.classList.remove('show')});
// Poll
setInterval(()=>{const ne=window.EJS_emulator;if(ne?.gameManager&&ne!==emu){setupCtrl();document.getElementById('stxt').textContent='Ready!';document.getElementById('sdot').className='sd ok';kv();
    // Focus game so inputs work
    const gd=document.getElementById('game');if(gd)gd.focus();
    const cv=gd?.querySelector('canvas');if(cv)cv.focus();
    // Log available methods for debugging
    console.log('EJS_emulator methods:', Object.keys(ne));
    console.log('gameManager methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(ne.gameManager)));
    if(isHost&&pConn)setTimeout(sendStream,2000)}},100);
// Boot
async function boot(){
    if(!isHost){document.getElementById('stxt').textContent='Waiting for P1 screen...';document.getElementById('sdot').className='sd wn';return}
    document.getElementById('sdot').className='sd wn';document.getElementById('stxt').textContent='Finding ROM...';
    try{const roms=await fetchDrive();const s=roms.find(r=>{const n=r.name.toLowerCase();return(n.includes('pokemon')||n.includes('pok√©mon'))&&n.includes('stadium')&&!n.includes('2')});
    if(s)await loadRom(s.id,s.name);else{document.getElementById('sdot').className='sd';document.getElementById('stxt').textContent='ROM not found'}}
    catch(e){document.getElementById('sdot').className='sd';document.getElementById('stxt').textContent='Load failed'}
}
setupPeer();boot();
['touchstart','click'].forEach(e=>document.addEventListener(e,()=>new(window.AudioContext||window.webkitAudioContext)().resume(),{once:true}));
</script>
</body>
</html>
